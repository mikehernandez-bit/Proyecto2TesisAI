{% extends "base.html" %}
{% block content %}

<!-- SIDEBAR (Navegación) -->
<aside class="w-64 bg-slate-900 text-white flex flex-col shadow-xl z-20 hidden md:flex">
  <div class="p-6 border-b border-slate-700 flex items-center gap-3">
    <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
      <i class="fa-solid fa-brain"></i>
    </div>
    <span class="text-xl font-bold tracking-tight">{{ app_name }}</span>
  </div>

  <nav class="flex-1 p-4 space-y-2">
    <button onclick="TesisAI.showView('dashboard')" id="nav-dashboard"
      class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition flex items-center gap-3 bg-slate-800 text-blue-400">
      <i class="fa-solid fa-chart-pie w-5"></i> Dashboard
    </button>

    <button onclick="TesisAI.showView('wizard')" id="nav-wizard"
      class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition flex items-center gap-3 text-slate-300">
      <i class="fa-solid fa-plus-circle w-5"></i> Nuevo Proyecto
    </button>

    <div class="pt-4 pb-2 px-4 text-xs font-semibold text-slate-500 uppercase">Administración</div>

    <button onclick="TesisAI.showView('admin-prompts')" id="nav-admin-prompts"
      class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition flex items-center gap-3 text-slate-300">
      <i class="fa-solid fa-robot w-5"></i> Gestión Prompts
    </button>

    <button onclick="TesisAI.showView('history')" id="nav-history"
      class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition flex items-center gap-3 text-slate-300">
      <i class="fa-solid fa-clock-rotate-left w-5"></i> Historial
    </button>
  </nav>

  <div class="p-4 border-t border-slate-700">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-full bg-slate-600 flex items-center justify-center">
        <i class="fa-solid fa-user"></i>
      </div>
      <div>
        <div class="text-sm font-medium">César Dev</div>
        <div class="text-xs text-slate-400">Admin</div>
      </div>
    </div>
  </div>
</aside>

<!-- MAIN CONTENT -->
<main class="flex-1 flex flex-col h-full overflow-hidden relative">

  <!-- Mobile Header -->
  <header class="bg-white border-b border-gray-200 p-4 flex justify-between items-center md:hidden">
    <span class="font-bold text-lg text-slate-800">{{ app_name }}</span>
    <button class="text-slate-600"><i class="fa-solid fa-bars"></i></button>
  </header>

  <!-- CONTENT AREA -->
  <div class="flex-1 overflow-y-auto p-4 md:p-8 relative">

    <!-- VISTA 1: DASHBOARD -->
    <div id="view-dashboard" class="view-section fade-in">
      <div class="flex justify-between items-end mb-8">
        <div>
          <h1 class="text-2xl font-bold text-slate-800">Panel Principal</h1>
          <p class="text-slate-500">Bienvenido. Aquí están tus últimas generaciones.</p>
        </div>
        <button onclick="TesisAI.showView('wizard')"
          class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg shadow-sm font-medium transition flex items-center gap-2">
          <i class="fa-solid fa-magic"></i> Generar Nuevo
        </button>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-sm text-gray-500 font-medium">Proyectos Totales</p>
              <h3 id="stat-total-projects" class="text-3xl font-bold text-slate-800 mt-1">0</h3>
            </div>
            <div class="p-2 bg-blue-50 text-blue-600 rounded-lg"><i class="fa-solid fa-folder-open"></i></div>
          </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-sm text-gray-500 font-medium">Ahorro de Tiempo</p>
              <h3 class="text-3xl font-bold text-slate-800 mt-1">~45h</h3>
            </div>
            <div class="p-2 bg-green-50 text-green-600 rounded-lg"><i class="fa-solid fa-clock"></i></div>
          </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-sm text-gray-500 font-medium">Tokens IA Usados</p>
              <h3 class="text-3xl font-bold text-slate-800 mt-1">125k</h3>
            </div>
            <div class="p-2 bg-purple-50 text-purple-600 rounded-lg"><i class="fa-solid fa-microchip"></i></div>
          </div>
        </div>
      </div>

      <!-- Recent Projects Table -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-100 font-semibold text-slate-700">Generaciones Recientes</div>
        <table class="w-full text-left border-collapse">
          <thead class="bg-gray-50 text-gray-500 text-xs uppercase">
            <tr>
              <th class="px-6 py-3 font-medium">Título / Tema</th>
              <th class="px-6 py-3 font-medium">Formato</th>
              <th class="px-6 py-3 font-medium">Estado</th>
              <th class="px-6 py-3 font-medium">Fecha</th>
              <th class="px-6 py-3 font-medium text-right">Acciones</th>
            </tr>
          </thead>
          <tbody id="dashboard-recent-projects" class="text-sm divide-y divide-gray-100"></tbody>
        </table>
        <div id="dashboard-empty" class="px-6 py-8 text-sm text-gray-500 hidden">
          No hay proyectos aún. Crea uno en "Nuevo Proyecto".
        </div>
      </div>
    </div>

    <!-- VISTA 2: WIZARD -->
    <div id="view-wizard" class="view-section hidden fade-in max-w-4xl mx-auto">

      <!-- Stepper -->
      <div class="mb-8">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-xl font-bold text-slate-800">Nuevo Proyecto</h2>
          <span class="text-sm text-gray-500">Paso <span id="current-step-label">1</span> de 6</span>
        </div>

        <div class="flex items-center w-full">
          <div id="step-1-dot"
            class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold text-sm z-10">
            1</div>
          <div id="step-1-line" class="flex-1 h-1 bg-gray-200 mx-2 rounded"></div>
          <div id="step-2-dot"
            class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold text-sm z-10">
            2</div>
          <div id="step-2-line" class="flex-1 h-1 bg-gray-200 mx-2 rounded"></div>
          <div id="step-3-dot"
            class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold text-sm z-10">
            3</div>
          <div id="step-3-line" class="flex-1 h-1 bg-gray-200 mx-2 rounded"></div>
          <div id="step-4-dot"
            class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold text-sm z-10">
            4</div>
          <div id="step-4-line" class="flex-1 h-1 bg-gray-200 mx-2 rounded"></div>
          <div id="step-5-dot"
            class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold text-sm z-10">
            5</div>
          <div id="step-5-line" class="flex-1 h-1 bg-gray-200 mx-2 rounded"></div>
          <div id="step-6-dot"
            class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold text-sm z-10">
            6</div>
        </div>

        <div class="flex justify-between text-xs text-gray-500 mt-2 px-1">
          <span>Formato Ext.</span>
          <span>Tipo & Prompt</span>
          <span>Detalles</span>
          <span>Seleccion IA</span>
          <span>Generando</span>
          <span>Descargas</span>
        </div>
      </div>

      <!-- Step 1 -->
      <div id="step-1-content" class="wizard-step">
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
          <h3 class="text-lg font-semibold mb-4 text-slate-800">1. Selecciona el Formato Institucional</h3>
          <p class="text-sm text-gray-500 mb-6">
            Se conecta a una API externa de formatos. En demo se usa <code
              class="bg-gray-100 px-1 rounded">data/formats_sample.json</code>.
          </p>

          <!-- GicaTesis offline banner (hidden by default, shown by JS) -->
          <div id="gicatesis-offline-banner"
            class="hidden mb-4 p-3 bg-amber-50 border border-amber-300 rounded-lg text-amber-800 text-sm flex items-center gap-2">
            <i class="fa-solid fa-triangle-exclamation"></i>
            <span>GicaTesis offline &mdash; mostrando formatos en cache. Logos y assets remotos no disponibles.</span>
          </div>

          <div class="flex gap-4 mb-6">
            <select id="filter-university"
              class="w-1/2 p-2.5 border border-gray-300 rounded-lg text-sm bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none">
              <option value="">Todas las Universidades</option>
            </select>
            <select id="filter-career"
              class="w-1/2 p-2.5 border border-gray-300 rounded-lg text-sm bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none">
              <option value="">Filtrar por Carrera</option>
            </select>
          </div>

          <div id="formats-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

          <div class="mt-8 flex justify-end">
            <button onclick="TesisAI.nextStep(2)" id="btn-step1-next"
              class="bg-blue-600 text-white px-6 py-2.5 rounded-lg hover:bg-blue-700 font-medium transition disabled:opacity-50 disabled:cursor-not-allowed"
              disabled>
              Siguiente: Elegir Prompt <i class="fa-solid fa-arrow-right ml-2"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Step 2 -->
      <div id="step-2-content" class="wizard-step hidden">
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
          <h3 class="text-lg font-semibold mb-4 text-slate-800">2. Que quieres que haga la IA?</h3>
          <p class="text-sm text-gray-500 mb-6">Prompts configurables desde Gestion Prompts.</p>

          <div id="prompts-grid" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>

          <div class="mt-8 flex justify-between">
            <button onclick="TesisAI.prevStep(1)"
              class="text-gray-500 hover:text-gray-700 font-medium px-4">Atras</button>
            <button onclick="TesisAI.nextStep(3)" id="btn-step2-next"
              class="bg-blue-600 text-white px-6 py-2.5 rounded-lg hover:bg-blue-700 font-medium transition disabled:opacity-50 disabled:cursor-not-allowed"
              disabled>
              Siguiente: Detalles <i class="fa-solid fa-arrow-right ml-2"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Step 3 -->
      <div id="step-3-content" class="wizard-step hidden">
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
          <h3 class="text-lg font-semibold mb-2 text-slate-800">3. Detalles del Proyecto</h3>
          <p class="text-sm text-gray-500 mb-6">Los campos se generan segun variables del prompt.</p>

          <div id="dynamic-form" class="space-y-4 max-w-2xl mx-auto"></div>

          <div id="step3-error" class="hidden mt-4 text-sm text-red-700 bg-red-50 border border-red-200 rounded p-3">
          </div>

          <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4 text-xs text-blue-800 flex gap-2">
            <i class="fa-solid fa-circle-info mt-0.5"></i>
            <p>
              Estos datos se utilizarán para generar el documento completo.
              <br />
              <span class="text-[10px] text-blue-600">El proceso puede tomar unos segundos mientras la IA procesa tu
                solicitud.</span>
            </p>
          </div>

          <div class="mt-8 flex justify-between items-center">
            <button onclick="TesisAI.prevStep(2)"
              class="text-gray-500 hover:text-gray-700 font-medium px-4">Atras</button>

            <div id="step3-loading"
              class="hidden flex items-center gap-3 text-blue-600 bg-blue-50 px-4 py-2 rounded-lg border border-blue-100">
              <div class="loader w-5 h-5 border-2 border-t-blue-600"></div>
              <span class="text-sm font-medium animate-pulse">Preparando selección IA...</span>
            </div>

            <button id="btn-step3-next-provider" onclick="TesisAI.goToProviderStep()"
              class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-2.5 rounded-lg shadow-md hover:shadow-lg hover:from-blue-700 hover:to-indigo-700 font-medium transition transform active:scale-95 disabled:opacity-60 disabled:cursor-not-allowed">
              <i class="fa-solid fa-arrow-right mr-2"></i> Siguiente: Seleccionar IA
            </button>
          </div>
        </div>
      </div>

      <!-- Step 4 -->
      <div id="step-4-content" class="wizard-step hidden">
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
          <h3 class="text-lg font-semibold mb-2 text-slate-800">4. Seleccionar IA</h3>
          <p class="text-sm text-gray-500 mb-6">
            Elige proveedor/modelo antes de iniciar la generación en vivo.
          </p>

          <div class="border border-slate-200 rounded-xl p-4 bg-slate-50 space-y-4">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
              <div>
                <h4 class="text-sm font-semibold text-slate-800">Selector de modelo IA</h4>
                <p class="text-xs text-slate-500">Salud en tiempo real: rate-limit y cuota.</p>
              </div>
              <button id="btn-provider-refresh" type="button"
                class="text-xs px-3 py-1.5 rounded border border-slate-300 text-slate-700 hover:bg-slate-100">
                <i class="fa-solid fa-rotate-right mr-1"></i> Actualizar estado
              </button>
            </div>

            <div class="flex flex-wrap items-center gap-4 text-xs">
              <div class="inline-flex rounded-lg border border-slate-300 overflow-hidden">
                <label class="px-3 py-2 cursor-pointer bg-white">
                  <input id="provider-mode-fixed" type="radio" name="provider-mode" value="fixed" class="mr-1">
                  Modo fijo
                </label>
                <label class="px-3 py-2 cursor-pointer bg-white border-l border-slate-300">
                  <input id="provider-mode-auto" type="radio" name="provider-mode" value="auto" class="mr-1" checked>
                  Modo automático
                </label>
              </div>
              <div id="provider-fallback-label" class="text-slate-600">Fallback: -</div>
            </div>

            <div id="provider-select-error"
              class="hidden text-xs text-red-700 bg-red-50 border border-red-200 rounded p-2"></div>
            <div id="provider-cards" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
          </div>

          <div id="step4-error" class="hidden mt-4 text-sm text-red-700 bg-red-50 border border-red-200 rounded p-3">
          </div>

          <div class="mt-8 flex justify-between items-center">
            <button onclick="TesisAI.prevStep(3)"
              class="text-gray-500 hover:text-gray-700 font-medium px-4">Atras</button>

            <div id="step4-loading"
              class="hidden flex items-center gap-3 text-blue-600 bg-blue-50 px-4 py-2 rounded-lg border border-blue-100">
              <div class="loader w-5 h-5 border-2 border-t-blue-600"></div>
              <span class="text-sm font-medium animate-pulse">Iniciando generacion...</span>
            </div>

            <button id="btn-step4-generate" onclick="TesisAI.triggerGeneration()"
              class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-2.5 rounded-lg shadow-md hover:shadow-lg hover:from-blue-700 hover:to-indigo-700 font-medium transition transform active:scale-95 disabled:opacity-60 disabled:cursor-not-allowed">
              <i class="fa-solid fa-wand-magic-sparkles mr-2"></i> Generar Documento
            </button>
          </div>
        </div>
      </div>

      <!-- Step 5: Generacion en progreso -->
      <div id="step-5-content" class="wizard-step hidden">
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 space-y-5">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
            <div>
              <h3 class="text-lg font-semibold text-slate-800">5. Generando documento</h3>
              <p id="gen-live-summary" class="text-sm text-slate-500">Inicializando ejecucion en vivo...</p>
            </div>
            <span id="gen-live-badge"
              class="inline-flex items-center gap-2 bg-blue-50 text-blue-700 border border-blue-200 rounded-full px-3 py-1 text-xs font-semibold">
              <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span>
              En vivo
            </span>
          </div>

          <div id="gen-timer" class="text-xs text-slate-500 hidden">
            Tiempo transcurrido: <span id="gen-timer-value">0s</span>
          </div>

          <div class="grid grid-cols-1 xl:grid-cols-3 gap-4">
            <section class="rounded-xl border border-slate-200 bg-slate-50 p-4 space-y-3">
              <h4 class="text-sm font-semibold text-slate-700">Pipeline en vivo</h4>
              <div id="gen-pipeline-nodes" class="space-y-2"></div>
              <div id="gen-pipeline-fallback"
                class="hidden text-xs text-amber-700 bg-amber-50 border border-amber-200 rounded-lg p-2"></div>
            </section>

            <section class="rounded-xl border border-slate-200 bg-white p-4 space-y-3">
              <h4 class="text-sm font-semibold text-slate-700">Documento construyendose</h4>
              <div id="gen-sections-progress" class="text-xs text-slate-500">Secciones 0/0</div>
              <div class="w-full h-2 rounded-full bg-slate-100 overflow-hidden">
                <div id="gen-sections-bar" class="h-2 bg-blue-500 transition-all duration-300" style="width:0%"></div>
              </div>
              <div id="gen-doc-blocks" class="grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
            </section>

            <section class="rounded-xl border border-slate-200 bg-white p-4 space-y-3">
              <h4 class="text-sm font-semibold text-slate-700">Timeline</h4>
              <div id="gen-trace-empty" class="text-xs text-slate-500">Aun no hay eventos.</div>
              <div id="gen-trace-timeline" class="space-y-2 max-h-[420px] overflow-y-auto pr-1"></div>
            </section>
          </div>

          <div id="gen-error" class="hidden bg-red-50 border border-red-200 text-red-700 text-sm rounded-lg p-3"></div>
          <div id="gen-success" class="hidden bg-green-50 border border-green-200 text-green-700 text-sm rounded-lg p-3">
            Documento generado exitosamente.
          </div>

          <div class="flex items-center justify-between pt-1">
            <button id="btn-gen-cancel" onclick="TesisAI.cancelGeneration()"
              class="text-gray-500 hover:text-gray-700 font-medium px-4 py-2">
              <i class="fa-solid fa-xmark mr-1"></i> Cancelar
            </button>
            <div class="flex gap-2">
              <button id="btn-gen-retry" onclick="TesisAI.retryGeneration()"
                class="hidden bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded text-sm">
                <i class="fa-solid fa-rotate-right mr-1"></i> Reintentar
              </button>
              <button id="btn-gen-downloads" onclick="TesisAI.goToDownloads()"
                class="hidden bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">
                <i class="fa-solid fa-download mr-1"></i> Ir a Descargas
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 6 -->
      <div id="step-6-content" class="wizard-step hidden">
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 space-y-6">
          <div>
            <h3 class="text-lg font-semibold text-slate-800">6. Descargas</h3>
            <p class="text-sm text-gray-500">Documento generado para el proyecto <code id="sim-project-id">-</code>.
            </p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <a id="sim-download-docx" href="#"
              class="inline-flex items-center justify-center gap-2 px-4 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition">
              <i class="fa-solid fa-file-word"></i> Descargar DOCX simulado
            </a>
            <a id="sim-download-pdf" href="#" target="_blank" rel="noopener noreferrer"
              class="inline-flex items-center justify-center gap-2 px-4 py-3 rounded-lg bg-slate-800 text-white hover:bg-slate-900 transition">
              <i class="fa-solid fa-file-pdf"></i> Descargar PDF simulado
            </a>
          </div>

          <div class="pt-2 flex justify-between">
            <button onclick="TesisAI.prevStep(5)"
              class="text-gray-500 hover:text-gray-700 font-medium px-4">Atras</button>
            <button onclick="TesisAI.showView('dashboard')"
              class="bg-slate-800 hover:bg-slate-900 text-white px-4 py-2 rounded">
              Finalizar
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- VISTA 3: ADMIN PROMPTS -->
    <div id="view-admin-prompts" class="view-section hidden fade-in">
      <div class="flex justify-between items-end mb-8">
        <div>
          <h1 class="text-2xl font-bold text-slate-800">Gestión de Prompts</h1>
          <p class="text-slate-500">Crea/edita prompts y variables para el Wizard.</p>
        </div>
        <button onclick="TesisAI.openPromptModal()"
          class="bg-slate-800 hover:bg-slate-900 text-white px-5 py-2 rounded-lg font-medium transition flex items-center gap-2">
          <i class="fa-solid fa-plus"></i> Nuevo Prompt
        </button>
      </div>

      <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <table class="w-full text-left border-collapse">
          <thead class="bg-gray-50 text-gray-500 text-xs uppercase">
            <tr>
              <th class="px-6 py-3">Nombre</th>
              <th class="px-6 py-3">Variables</th>
              <th class="px-6 py-3">Estado</th>
              <th class="px-6 py-3 text-right">Acciones</th>
            </tr>
          </thead>
          <tbody id="prompts-table" class="text-sm divide-y divide-gray-100"></tbody>
        </table>
        <div id="prompts-empty" class="px-6 py-8 text-sm text-gray-500 hidden">
          No hay prompts. Crea uno con "Nuevo Prompt".
        </div>
      </div>
    </div>

    <!-- VISTA 4: HISTORIAL -->
    <div id="view-history" class="view-section hidden fade-in">
      <div class="flex justify-between items-end mb-8">
        <div>
          <h1 class="text-2xl font-bold text-slate-800">Historial de Generaciones</h1>
          <p class="text-slate-500">Descarga o revisa proyectos anteriores.</p>
        </div>
        <div class="flex gap-2">
          <div class="relative">
            <i class="fa-solid fa-search absolute left-3 top-2.5 text-gray-400 text-sm"></i>
            <input id="history-search" type="text" placeholder="Buscar proyecto..."
              class="pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm outline-none focus:ring-1 focus:ring-blue-500 w-64">
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <table class="w-full text-left border-collapse">
          <thead class="bg-gray-50 text-gray-500 text-xs uppercase">
            <tr>
              <th class="px-6 py-3">Proyecto / Prompt</th>
              <th class="px-6 py-3">Formato</th>
              <th class="px-6 py-3">Estado</th>
              <th class="px-6 py-3">Fecha</th>
              <th class="px-6 py-3 text-right">Acciones</th>
            </tr>
          </thead>
          <tbody id="history-table" class="text-sm divide-y divide-gray-100"></tbody>
        </table>
        <div id="history-empty" class="px-6 py-8 text-sm text-gray-500 hidden">
          No hay historial todavía.
        </div>
      </div>
    </div>

  </div>
</main>

<!-- MODAL: CREAR/EDITAR PROMPT -->
<div id="modal-prompt" class="fixed inset-0 z-50 hidden modal-backdrop flex items-center justify-center p-4">
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl transform transition-all scale-100">
    <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
      <h3 id="modal-title" class="text-lg font-bold text-slate-800">Configurar Prompt</h3>
      <button onclick="TesisAI.closePromptModal()" class="text-gray-400 hover:text-gray-600">
        <i class="fa-solid fa-xmark fa-lg"></i>
      </button>
    </div>

    <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
      <input type="hidden" id="modal-prompt-id" value="">

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nombre del Prompt</label>
          <input id="modal-name" type="text"
            class="w-full p-2 border border-gray-300 rounded text-sm focus:border-blue-500 outline-none"
            placeholder="Ej: Tesis Derecho Civil">
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tipo Documento</label>
          <select id="modal-doc-type"
            class="w-full p-2 border border-gray-300 rounded text-sm focus:border-blue-500 outline-none">
            <option>Tesis Completa</option>
            <option>Artículo Científico</option>
            <option>Ensayo / Monografía</option>
          </select>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <input id="modal-is-active" type="checkbox" class="h-4 w-4" checked>
        <label class="text-sm text-gray-700">Activo</label>
      </div>

      <div>
        <div class="flex justify-between items-center mb-1">
          <label class="block text-xs font-bold text-gray-500 uppercase">Instrucciones para la IA</label>
          <span class="text-[10px] text-blue-600 bg-blue-50 px-2 py-0.5 rounded">Usa {{'{{variable}}'}} para
            dinamismo</span>
        </div>
        <textarea id="modal-template"
          class="w-full p-3 border border-gray-300 rounded text-sm font-mono h-40 focus:border-blue-500 outline-none resize-none bg-gray-50"
          placeholder="Actúa como un experto investigador académico.
El tema es: {{tema}}
El objetivo: {{objetivo_general}}
..."></textarea>
      </div>

      <div>
        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Variables (JSON Array)</label>
        <input id="modal-vars" type="text"
          class="w-full p-2 border border-gray-300 rounded text-sm font-mono text-gray-600 focus:border-blue-500 outline-none"
          value='["tema","objetivo_general"]'>
        <p class="text-[10px] text-gray-400 mt-1">Estas variables generan automáticamente los campos del Paso 3.</p>
      </div>

      <div id="modal-error" class="hidden bg-red-50 border border-red-200 text-red-700 text-sm rounded p-3"></div>
    </div>

    <div class="px-6 py-4 bg-gray-50 rounded-b-xl flex justify-end gap-3">
      <button onclick="TesisAI.closePromptModal()"
        class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-800">Cancelar</button>
      <button onclick="TesisAI.savePrompt()"
        class="px-4 py-2 text-sm font-bold text-white bg-slate-800 rounded hover:bg-slate-900 shadow-sm">
        Guardar Prompt
      </button>
    </div>
  </div>
</div>

{% endblock %}
