%% Arquitectura GicaGen - Diagrama Mermaid
%% Usar en: https://mermaid.live o integrado en Markdown
%% Actualizado: refleja estructura real del codigo

graph TB
    subgraph "UI Layer"
        BROWSER[Browser]
        JS["app.js - SPA (898 lineas)"]
        TEMPLATES["Jinja Templates (464 lineas)"]
    end
    
    subgraph "API Layer"
        API["api/router.py (730 lineas)"]
        MODELS["api/models.py (5 modelos Pydantic)"]
    end
    
    subgraph "Core Services"
        direction TB
        FMT_SVC[FormatService]
        PRM_SVC[PromptService]
        PRJ_SVC[ProjectService]
        DOCX_SVC[DocxBuilder]
        N8N_CLIENT[N8NClient]
        N8N_INT[N8NIntegrationService]
        DEF_COMP[DefinitionCompiler]
        SIM_ART[SimulationArtifactService]
    end
    
    subgraph "Integrations"
        GT_CLIENT["GicaTesisClient (async)"]
        GT_CACHE["FormatCache (ETag)"]
        GT_TYPES["DTOs + Errors"]
    end
    
    subgraph "Infrastructure"
        JSON_STORE[JsonStore]
        CONFIG[config.py]
        TMPL_CFG[templates.py]
    end
    
    subgraph "External Systems"
        GICATESIS["GicaTesis API v1 (puerto 8000)"]
        N8N_WH["n8n Webhook (opcional)"]
        FS["Filesystem (data/*.json)"]
    end
    
    BROWSER --> JS
    JS --> API
    API --> MODELS
    API --> FMT_SVC
    API --> PRM_SVC
    API --> PRJ_SVC
    API --> DOCX_SVC
    API --> N8N_CLIENT
    API --> N8N_INT
    API --> SIM_ART
    
    N8N_INT --> DEF_COMP
    SIM_ART --> DEF_COMP
    
    FMT_SVC --> GT_CLIENT
    FMT_SVC --> GT_CACHE
    FMT_SVC --> GT_TYPES
    FMT_SVC --> CONFIG
    
    GT_CLIENT --> GICATESIS
    GT_CACHE --> FS
    
    PRM_SVC --> JSON_STORE
    PRJ_SVC --> JSON_STORE
    JSON_STORE --> FS
    
    N8N_CLIENT --> CONFIG
    N8N_CLIENT -.-> N8N_WH
    
    SIM_ART --> FS
    
    MAIN[main.py] --> API
    MAIN --> UI_ROUTER[ui/router.py]
    UI_ROUTER --> TEMPLATES
    UI_ROUTER --> TMPL_CFG
